<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neurosurgery e-Logbook</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- CORE STYLES --- */
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; color: #333; margin: 0; padding: 10px; font-size: 13px; }
        .container { width: 100%; max-width: 1400px; margin: 0 auto; background: white; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-radius: 10px; position: relative; }
        
        .header { text-align: center; border-bottom: 3px solid #003366; padding-bottom: 15px; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #003366; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; }
        .header h2 { margin: 5px 0; color: #555; font-size: 1rem; font-weight: normal; }
        .settings-btn { position: absolute; top: 15px; right: 15px; background: #eee; border: 1px solid #ccc; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; width: 40px; height: 40px; }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: flex-start; padding-top: 50px; overflow-y: auto; }
        .modal-box { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 650px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 50px; }
        .code-block { background: #f4f4f4; border: 1px solid #ddd; padding: 10px; font-family: monospace; font-size: 0.8em; height: 150px; overflow-y: scroll; white-space: pre; margin-bottom: 10px; display: block; width: 100%; box-sizing: border-box; color: #333; }
        .setup-input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn-green { background: #28a745; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .step-list { padding-left: 20px; line-height: 1.5; color: #444; margin-bottom: 15px; }
        
        /* TABS */
        .tab-buttons { display: flex; overflow-x: auto; gap: 5px; border-bottom: 2px solid #ddd; margin-bottom: 15px; }
        .tab-btn { padding: 10px 20px; background: #f1f1f1; border: none; border-radius: 5px 5px 0 0; font-weight: bold; cursor: pointer; color: #555; white-space: nowrap; }
        .tab-btn.active { background: #003366; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* SUMMARY */
        h1.main-divider { background-color: #003366; color: white; padding: 10px; text-align: center; margin-top: 40px; margin-bottom: 20px; font-size: 1.2rem; text-transform: uppercase; border-radius: 5px; }
        h2.section-title { background-color: #eef4ff; padding: 8px; border-left: 5px solid #003366; margin-top: 15px; font-size: 1rem; color: #003366; font-weight: bold; }
        h3.summary-header { background: #f8f9fa; padding: 8px; border-left: 4px solid #003366; margin-top: 20px; font-size: 1rem; color: #333; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.85rem; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; }
        th { background: #f8f9fa; font-weight: bold; color: #333; }
        
        .summary-table td:last-child { width: 60px; text-align: center; font-weight: bold; background: white; }
        
        /* INPUTS */
        input, textarea, select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 12px; }
        textarea { resize: vertical; min-height: 35px; }
        .img-link { display: inline-block; margin-top: 4px; font-size: 0.8em; color: #0056b3; background: #eef; padding: 2px 5px; border-radius: 3px; text-decoration: none; }
        input[type="file"] { border: none; font-size: 0.85em; width: 90px; }

        /* BUTTONS */
        .btn-add { background: #003366; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px; font-weight: bold; }
        .btn-del { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8em; }
        .cloud-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; width: 100%; max-width: 200px; color: white; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .log-table thead { display: none; }
            .log-table tr { display: block; margin-bottom: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .log-table td { display: block; border: none; padding: 5px 0; }
            .log-table td::before { content: attr(data-label); font-weight: bold; display: block; color: #888; font-size: 0.75em; text-transform: uppercase; }
        }

        /* PDF MODE */
        .show-for-pdf { display: block !important; }
        .pdf-mode .tab-buttons, .pdf-mode .cloud-section, .pdf-mode .settings-btn, .pdf-mode .btn-add, .pdf-mode .btn-del { display: none !important; }
        .pdf-mode input, .pdf-mode textarea, .pdf-mode select { border: none !important; background: transparent !important; padding: 0; resize: none; appearance: none; }
        .pdf-mode input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container" id="logbook-content">
    <button class="settings-btn" onclick="openSetup()" title="Connect Drive">‚öôÔ∏è</button>
    <div class="header">
        <h1>Neurosurgery e-Logbook</h1>
        <h2>Surgical Training Record</h2>
    </div>

    <div class="modal-overlay" id="setup-modal">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#003366;">‚öôÔ∏è Connect Your Cloud</h3>
            <p><strong>Step 1:</strong> Copy this New Code (Updates Spreadsheet Rows):</p>
            
            <textarea id="script-code" class="code-block" readonly onclick="this.select()">
function doPost(e){
  var lock = LockService.getScriptLock(); lock.tryLock(10000);
  try{
    var p=JSON.parse(e.postData.contents);
    var ss=SpreadsheetApp.getActiveSpreadsheet();
    
    // 1. Save Raw Data for App Loading
    var sRaw=ss.getSheetByName("App_Raw_Data"); 
    if(!sRaw) sRaw=ss.insertSheet("App_Raw_Data");
    sRaw.clear();
    
    var pl=proc(p.content.logs);
    var dataToSave = { logs: pl, academics: p.content.academics };
    sRaw.getRange(1,1).setValue(JSON.stringify(dataToSave));

    // 2. Save Readable Rows to Sheets
    updateSheet(ss, "Endovascular_Log", pl.endo, ["Date","IP","Category","Diagnosis","Role","Surgeon","Pre-Op","Post-Op"]);
    updateSheet(ss, "Open_Surgery_Log", pl.open, ["Date","IP","Category","Diagnosis","Role","Surgeon","Pre-Op","Post-Op"]);
    
    // 3. Save Academics
    var acaFlat = [];
    if(p.content.academics){
      for(var k in p.content.academics) {
        // k is the type (sem, conf, pub), r is the row data
        p.content.academics[k].forEach(r => acaFlat.push([r.date, k.toUpperCase(), r.c1, r.c2, r.c3])); 
      }
    }
    updateSheetArray(ss, "Academics_Log", acaFlat, ["Date","Category","Field 1","Field 2","Field 3"]);

    return ContentService.createTextOutput(JSON.stringify({status:"success"}));
  }catch(e){return ContentService.createTextOutput(JSON.stringify({status:"error",m:e.toString()}));}
  finally{lock.releaseLock();}
}

function updateSheet(ss, name, data, headers){
  var s = ss.getSheetByName(name);
  if(!s) s = ss.insertSheet(name);
  s.clear();
  s.appendRow(headers);
  s.setFrozenRows(1);
  if(data && data.length > 0){
    var rows = data.map(r => [r.date, r.ip, r.cat, r.dx, r.role, r.surg, r.preLink, r.postLink]);
    s.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
  }
}

function updateSheetArray(ss, name, rows, headers){
  var s = ss.getSheetByName(name);
  if(!s) s = ss.insertSheet(name);
  s.clear();
  s.appendRow(headers);
  s.setFrozenRows(1);
  if(rows && rows.length > 0){
    s.getRange(2, 1, rows.length, rows[0].length).setValues(rows);
  }
}

function doGet(e){
  try{
    var s=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("App_Raw_Data");
    var d=s.getRange(1,1).getValue();
    if(!d) return ContentService.createTextOutput(JSON.stringify({status:"success", data:{logs:{endo:[],open:[]}, academics:{sem:[],conf:[],pub:[]}} }));
    return ContentService.createTextOutput(JSON.stringify({status:"success",data:JSON.parse(d)}));
  }catch(e){return ContentService.createTextOutput(JSON.stringify({status:"error", m:"No Data"}));}
}

function proc(l){
  var f=DriveApp.getFoldersByName("Logbook_Images");
  var d=f.hasNext()?f.next():DriveApp.createFolder("Logbook_Images");
  for(var k in l){
    for(var i=0;i<l[k].length;i++){
      var r=l[k][i];
      if(r.preLink&&r.preLink.startsWith("data:")) r.preLink=sv(d,r.preLink,r.ip+"_pre_"+r.date);
      if(r.postLink&&r.postLink.startsWith("data:")) r.postLink=sv(d,r.postLink,r.ip+"_pos_"+r.date);
    }
  }
  return l;
}

function sv(f,b,n){
  var s=b.split("base64,");
  var t=s[0].split(":")[1].split(";")[0];
  var bl=Utilities.newBlob(Utilities.base64Decode(s[1]),t,n);
  return f.createFile(bl).getUrl();
}
            </textarea>
            
            <button onclick="copyCode()" style="background:#eee; border:1px solid #ccc; padding:5px; width:100%; cursor:pointer; margin-bottom:15px;">üìã Copy to Clipboard</button>

            <p><strong>Step 2:</strong> Update Backend</p>
            <ol class="step-list">
                <li>Go to <a href="https://script.google.com/home" target="_blank">script.google.com</a>.</li>
                <li>Paste code. <strong>Click Deploy > Manage Deployments > Edit (Pencil) > New Version > Deploy.</strong></li>
                <li>Copy the <strong>Web App URL</strong> and paste it below:</li>
            </ol>

            <input type="text" id="user-url" class="setup-input" placeholder="https://script.google.com/macros/s/..../exec">
            <button class="btn-green" onclick="saveUrl()">Save & Connect</button>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <button onclick="resetApp()" style="width:100%; padding:10px; background:#dc3545; color:white; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">‚ö†Ô∏è Reset App (Clear Data)</button>
            
            <button onclick="closeSetup()" style="margin-top:10px; background:none; border:none; color:#666; cursor:pointer; width:100%">Close</button>
        </div>
    </div>

    <div class="tab-buttons" data-html2canvas-ignore="true">
        <button class="tab-btn active" onclick="switchTab('summary')">1. Summary</button>
        <button class="tab-btn" onclick="switchTab('logs')">2. Daily Logs</button>
        <button class="tab-btn" onclick="switchTab('academics')">3. Academics</button>
    </div>

    <div id="summary" class="tab-content active">
        <div style="background:#e8f0fe; padding:10px; border-left:4px solid #003366; margin-bottom:15px;">
            <strong>Live Stats:</strong> Totals update automatically when you select categories in Daily Logs.
        </div>
        <div id="summary-container"></div>
    </div>

    <div id="logs" class="tab-content">
        <h3 class="summary-header">Endovascular Log</h3>
        <button class="btn btn-add" onclick="addRow('log-endo')">+ Add Case</button>
        <table class="log-table" id="log-endo">
            <thead><tr><th width="10%">Date</th><th width="10%">IP</th><th width="20%">Category</th><th>Dx & Proc</th><th width="10%">Role</th><th width="10%">Surg</th><th width="10%">Img</th><th width="5%">X</th></tr></thead><tbody></tbody>
        </table>

        <h3 class="summary-header">Operative Log (Open)</h3>
        <button class="btn btn-add" onclick="addRow('log-open')">+ Add Case</button>
        <table class="log-table" id="log-open">
            <thead><tr><th width="10%">Date</th><th width="10%">IP</th><th width="20%">Category</th><th>Dx & Proc</th><th width="10%">Role</th><th width="10%">Surg</th><th width="10%">Img</th><th width="5%">X</th></tr></thead><tbody></tbody>
        </table>
    </div>

    <div id="academics" class="tab-content">
        <h3 class="summary-header">Seminars & Journal Club</h3>
        <button class="btn btn-add" onclick="addAcad('acad-sem', ['Date','Topic','Type','Faculty'])">+ Add</button>
        <table class="log-table" id="acad-sem"><thead><tr><th>Date</th><th>Topic</th><th>Type</th><th>Faculty</th><th>X</th></tr></thead><tbody></tbody></table>

        <h3 class="summary-header">Conferences & Workshops</h3>
        <button class="btn btn-add" onclick="addAcad('acad-conf', ['Date','Name','Location','Role'])">+ Add</button>
        <table class="log-table" id="acad-conf"><thead><tr><th>Date</th><th>Name</th><th>Location</th><th>Role</th><th>X</th></tr></thead><tbody></tbody></table>

        <h3 class="summary-header">Papers & Publications</h3>
        <button class="btn btn-add" onclick="addAcad('acad-pub', ['Date','Title','Journal','Status'])">+ Add</button>
        <table class="log-table" id="acad-pub"><thead><tr><th>Date</th><th>Title</th><th>Journal</th><th>Status</th><th>X</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="cloud-section" style="margin-top:30px; text-align:center; padding:20px; background:#eee; border-radius:8px;" data-html2canvas-ignore="true">
        <p id="sync-msg" style="color:#666;">Not connected.</p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button class="cloud-btn" style="background:#28a745" onclick="syncCloud('save')">‚¨Ü Save to Drive</button>
            <button class="cloud-btn" style="background:#007bff" onclick="syncCloud('load')">‚¨á Load from Drive</button>
        </div>
        <div id="status" style="margin-top:10px; font-weight:bold;"></div>
        <hr>
        <button class="cloud-btn" style="background:#555" onclick="generatePDF()">Download PDF</button>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const CONFIG = {
        "ADULT: Cerebrovascular": [
            {id:"cv_ant", l:"Aneurysm: Anterior"}, {id:"cv_post", l:"Aneurysm: Posterior"}, {id:"cv_avm", l:"AVM Excision"},
            {id:"cv_cea", l:"Carotid Endarterectomy"}, {id:"cv_bp", l:"EC-IC Bypass"}, {id:"cv_ich", l:"ICH Evacuation"},
            {id:"en_coil", l:"Endo: Coiling (All)"}, {id:"en_flow", l:"Endo: Flow Diverter"}, {id:"en_emb", l:"Endo: Embolization"},
            {id:"en_str", l:"Endo: Stroke"}, {id:"en_vas", l:"Endo: Vasospasm"}
        ],
        "ADULT: Tumour": [
            {id:"tm_gli", l:"Glioma (All)"}, {id:"tm_men", l:"Meningioma"}, {id:"tm_pit", l:"Pituitary"},
            {id:"tm_cpa", l:"CP Angle"}, {id:"tm_met", l:"Metastasis"}, {id:"tm_skl", l:"Skull Base"}, {id:"tm_pf", l:"Post Fossa"}, {id:"tm_bio", l:"Biopsy"}
        ],
        "ADULT: Spine": [
            {id:"sp_acdf", l:"ACDF"}, {id:"sp_disc", l:"Discectomy"}, {id:"sp_lam", l:"Laminectomy"},
            {id:"sp_fus", l:"Post Fusion"}, {id:"sp_tum", l:"Spinal Tumour"}, {id:"sp_tra", l:"Trauma"}, {id:"sp_cvj", l:"CV Junction"}
        ],
        "ADULT: Other": [
            {id:"tr_sdh", l:"Subdural"}, {id:"tr_edh", l:"Extradural"}, {id:"tr_cra", l:"Cranioplasty"},
            {id:"ot_hyd", l:"Hydrocephalus"}, {id:"ot_inf", l:"Infection"}, {id:"ot_pai", l:"Pain/Func"}, {id:"ot_pn", l:"Peripheral Nerve"}
        ],
        "PAEDIATRIC": [
            {id:"pd_tum", l:"Paediatric Tumour"}, {id:"pd_hyd", l:"Hydrocephalus"}, {id:"pd_spi", l:"Dysraphism"},
            {id:"pd_tra", l:"Trauma"}, {id:"pd_cra", l:"Craniosynostosis"}
        ]
    };

    // --- 2. INITIALIZATION ---
    window.onload = function() {
        // Build Summary Table
        let html = "";
        for (const [sec, items] of Object.entries(CONFIG)) {
            html += `<h1 class="main-divider" style="margin:10px 0 5px 0; font-size:0.9em">${sec}</h1><table class="summary-table">`;
            items.forEach(i => html += `<tr><td>${i.l}</td><td id="cnt_${i.id}">0</td></tr>`);
            html += `</table>`;
        }
        document.getElementById('summary-container').innerHTML = html;

        // Load Local & Check Cloud
        loadLocal();
        if(document.querySelectorAll('tbody tr').length === 0) { addRow('log-endo'); addRow('log-open'); }
        if(localStorage.getItem('CloudURL')) document.getElementById('sync-msg').innerHTML = "‚úÖ Connected to Drive";
    };

    // --- 3. LOGIC ---
    function getCatOpts(sel) {
        let h = '<option value="">-- Select --</option>';
        for (const [sec, items] of Object.entries(CONFIG)) {
            h += `<optgroup label="${sec}">`;
            items.forEach(i => h += `<option value="${i.id}" ${i.id===sel?'selected':''}>${i.l}</option>`);
            h += `</optgroup>`;
        }
        return h;
    }

    function updateStats() {
        document.querySelectorAll('[id^="cnt_"]').forEach(e => e.innerText = "0");
        document.querySelectorAll('.cat-select').forEach(s => {
            if(s.value) {
                const t = document.getElementById(`cnt_${s.value}`);
                if(t) t.innerText = parseInt(t.innerText) + 1;
            }
        });
        saveLocal();
    }

    function addRow(id, d={}) {
        const row = document.createElement('tr');
        // Image Links logic
        const preL = d.preLink ? `<a href="${d.preLink}" target="_blank" class="img-link">Pre</a>` : '';
        const postL = d.postLink ? `<a href="${d.postLink}" target="_blank" class="img-link">Post</a>` : '';

        row.innerHTML = `
            <td><input type="date" class="d-date" value="${d.date||''}" onchange="saveLocal()"></td>
            <td><input type="text" class="d-ip" value="${d.ip||''}" oninput="saveLocal()"></td>
            <td><select class="cat-select" onchange="updateStats()">${getCatOpts(d.cat)}</select></td>
            <td><textarea class="d-dx" oninput="saveLocal()">${d.dx||''}</textarea></td>
            <td><select class="d-role" onchange="saveLocal()"><option>Primary</option><option ${d.role==='Assistant'?'selected':''}>Assistant</option><option ${d.role==='Observer'?'selected':''}>Observer</option></select></td>
            <td><input type="text" class="d-surg" value="${d.surg||''}" oninput="saveLocal()"></td>
            <td style="font-size:0.8em">
                <input type="file" class="f-pre" accept="image/*" title="Pre"><br><input type="file" class="f-post" accept="image/*" title="Post">
                <div>${preL} ${postL}</div>
                <input type="hidden" class="h-pre" value="${d.preLink||''}"><input type="hidden" class="h-post" value="${d.postLink||''}">
            </td>
            <td><button class="btn-del" onclick="this.closest('tr').remove();updateStats()">X</button></td>`;
        document.getElementById(id).querySelector('tbody').appendChild(row);
        updateStats();
    }

    function addAcad(id, ph, d={}) {
        const row = document.createElement('tr');
        row.innerHTML = `<td><input type="date" class="a-date" value="${d.date||''}" onchange="saveLocal()"></td>
        <td><textarea class="a-c1" oninput="saveLocal()" placeholder="${ph[1]}">${d.c1||''}</textarea></td>
        <td><input type="text" class="a-c2" value="${d.c2||''}" oninput="saveLocal()" placeholder="${ph[2]}"></td>
        <td><input type="text" class="a-c3" value="${d.c3||''}" oninput="saveLocal()" placeholder="${ph[3]}"></td>
        <td><button class="btn-del" onclick="this.closest('tr').remove();saveLocal()">X</button></td>`;
        document.getElementById(id).querySelector('tbody').appendChild(row);
    }

    // --- 4. CLOUD & DATA ---
    const toBase64 = f => new Promise((res, rej) => {
        const reader = new FileReader(); reader.readAsDataURL(f);
        reader.onload = () => res(reader.result); reader.onerror = error => rej(error);
    });

    async function scrapeData() {
        const logs = { endo: [], open: [] };
        for (const type of ['endo', 'open']) {
            const rows = document.querySelectorAll(`#log-${type} tbody tr`);
            for (const r of rows) {
                const fp = r.querySelector('.f-pre').files[0], fpo = r.querySelector('.f-post').files[0];
                let pre = r.querySelector('.h-pre').value, post = r.querySelector('.h-post').value;
                if (fp) pre = await toBase64(fp);
                if (fpo) post = await toBase64(fpo);
                logs[type].push({
                    date: r.querySelector('.d-date').value, ip: r.querySelector('.d-ip').value,
                    cat: r.querySelector('.cat-select').value, dx: r.querySelector('.d-dx').value,
                    role: r.querySelector('.d-role').value, surg: r.querySelector('.d-surg').value,
                    preLink: pre, postLink: post
                });
            }
        }
        const academics = { sem:[], conf:[], pub:[] };
        ['sem', 'conf', 'pub'].forEach(k => {
            document.querySelectorAll(`#acad-${k} tbody tr`).forEach(r => {
                academics[k].push({ date: r.querySelector('.a-date').value, c1: r.querySelector('.a-c1').value, c2: r.querySelector('.a-c2').value, c3: r.querySelector('.a-c3').value });
            });
        });
        return { logs, academics };
    }

    async function syncCloud(action) {
        const url = localStorage.getItem('CloudURL');
        if (!url) { openSetup(); return; }
        const status = document.getElementById('status');
        status.innerText = "Processing..."; status.style.color = "blue";

        if (action === 'save') {
            try {
                const data = await scrapeData();
                await fetch(url, { method: "POST", mode: "no-cors", body: JSON.stringify({ action: "save", content: data }) });
                status.innerText = "‚úÖ Saved!"; status.style.color = "green";
            } catch(e) { status.innerText = "‚ùå Error"; status.style.color = "red"; }
        } else {
            fetch(url + "?action=get").then(r => r.json()).then(res => {
                if (res.status === "success") {
                    document.querySelectorAll('tbody').forEach(e => e.innerHTML = "");
                    if(res.data.logs) {
                        if(res.data.logs.endo) res.data.logs.endo.forEach(d => addRow('log-endo', d));
                        if(res.data.logs.open) res.data.logs.open.forEach(d => addRow('log-open', d));
                    }
                    if(res.data.academics) {
                        ['sem', 'conf', 'pub'].forEach(k => { if(res.data.academics[k]) res.data.academics[k].forEach(d => addAcad(`acad-${k}`, [], d)); });
                    }
                    updateStats();
                    status.innerText = "‚úÖ Loaded!"; status.style.color = "green";
                } else { status.innerText = "‚ö†Ô∏è No Data"; }
            }).catch(e => { status.innerText = "‚ùå Error Load"; });
        }
    }

    // --- 5. LOCAL STORAGE ---
    async function saveLocal() {
        const data = await scrapeData();
        for(let k in data.logs) data.logs[k].forEach(r => { if(r.preLink.startsWith('data')) r.preLink=''; if(r.postLink.startsWith('data')) r.postLink=''; });
        localStorage.setItem("NeuroLog_Backup", JSON.stringify(data));
    }

    function loadLocal() {
        const d = JSON.parse(localStorage.getItem("NeuroLog_Backup"));
        if(d) {
            if(d.logs) {
                if(d.logs.endo) d.logs.endo.forEach(r => addRow('log-endo', r));
                if(d.logs.open) d.logs.open.forEach(r => addRow('log-open', r));
            }
            if(d.academics) {
                if(d.academics.sem) d.academics.sem.forEach(r => addAcad('acad-sem', [], r));
                if(d.academics.conf) d.academics.conf.forEach(r => addAcad('acad-conf', [], r));
                if(d.academics.pub) d.academics.pub.forEach(r => addAcad('acad-pub', [], r));
            }
            updateStats();
        }
    }

    // --- UTILS ---
    function switchTab(id) { document.querySelectorAll('.tab-content, .tab-btn').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }
    function openSetup() { document.getElementById('setup-modal').style.display = 'flex'; }
    function closeSetup() { document.getElementById('setup-modal').style.display = 'none'; }
    function copyCode() { document.getElementById('script-code').select(); document.execCommand('copy'); alert("Copied!"); }
    function saveUrl() { localStorage.setItem('CloudURL', document.getElementById('user-url').value); closeSetup(); location.reload(); }
    
    function resetApp() {
        if(confirm("Are you sure? This will delete all Local Data and disconnect your Cloud URL. (Your data on Google Drive will remain safe).")) {
            localStorage.removeItem("NeuroLog_Backup");
            localStorage.removeItem("CloudURL");
            location.reload();
        }
    }

    function generatePDF() { document.body.classList.add('pdf-mode'); document.querySelectorAll('.tab-content').forEach(e=>e.style.display='block'); html2pdf().from(document.getElementById('logbook-content')).save().then(()=>{location.reload()}); }
</script>
</body>
</html>
